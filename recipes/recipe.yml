# yaml-language-server: $schema=https://schema.blue-build.org/recipe-v1.json
name: ShardOS
description: Specialized host image for high-performance VMs and containers with dGPU passthrough and Image Building capabilities.

# 1. BASE IMAGE: Using the Zen Kernel variant for high performance and low latency
base-image: ghcr.io/ublue-os/silverblue-main-zen
image-version: latest

modules:
  # 1. CORE SYSTEM FILES
  - type: files
    files:
      - source: system
        destination: /

  # 2. ADD EXTERNAL REPOSITORIES (RPM Fusion for codecs/drivers)
  - type: rpm
    install:
      # RPM Fusion (Free)
      - https://mirrors.rpmfusion.org/free/fedora/rpmfusion-free-release-$(rpm -E %fedora).noarch.rpm
      # RPM Fusion (Non-Free)
      - https://mirrors.rpmfusion.org/nonfree/fedora/rpmfusion-nonfree-release-$(rpm -E %fedora).noarch.rpm

  # 3. DNF/RPM-OSTREE: Install Virtualization, Cockpit, SELinux Tools, and OSBuild Composer
  - type: dnf
    repos:
      # COPR for up-to-date Starship prompt
      copr:
        - atim/starship
    install:
      # CORE UPDATE TOOL
      - ublue-update              # Core update management tool

      # Essential user tools
      - micro
      - starship
      
      # VIRTUALIZATION & KVM (Host Hypervisor)
      - qemu-kvm
      - libvirt
      - libvirt-client
      - libvirt-daemon-kvm
      - libvirt-daemon-config-network
      - virt-install
      - edk2-ovmf             # UEFI Firmware
      - virt-viewer           # Remote console viewer
      
      # CONTAINER MANAGEMENT (Core Tools)
      - podman
      - skopeo
      - buildah
      - podman-compose          # Compose support
      - podman-docker           # Docker compatibility symlinks
      - containers-tools        # Utility tools

      # MULTIMEDIA/CODECS (Requires RPM Fusion)
      - libavcodec-freeworld

      # SYSTEM MANAGEMENT, MONITORING, & TUNING
      - cockpit
      - cockpit-machines 
      - cockpit-podman
      - cockpit-files           # Cockpit file browser
      - cockpit-networkmanager  # Cockpit network module
      - cockpit-selinux         # Cockpit SELinux module
      - cockpit-packagekit
      - cockpit-storaged
      - cockpit-pcp
      - pcp                     # Core PCP package
      - python3-pcp             # Python bindings for PCP
      - pcp-system-tools
      - tuned                   # System performance tuner
      - sysstat
      
      # NETWORKING, STORAGE & FIREWALL
      - firewalld               # Host firewall
      - iptables
      - openssh-server
      - cryptsetup              # Disk encryption utility
      - lvm2                    # Logical Volume Manager
      - mdadm                   # Software RAID manager
      
      # SECURITY & AUTHENTICATION
      - policycoreutils-python-utils 
      - setroubleshoot-server
      - audit
      - setools-console
      
      # HARDWARE FIRMWARE
      - fwupd                   # Firmware Updater
      - amd-ucode-firmware      # AMD Microcode
      - microcode_ctl           # Intel/AMD Microcode Control
      
      # OSBUILD COMPOSER
      - osbuild-composer
      - composer-cli
      
    remove: 
      packages:
        - firefox               # Base Firefox RPM removed
        - firefox-langpacks     # Firefox language packs removed
        - gnome-calculator
        - gnome-contacts
        - gnome-maps
        - totem 
        - yelp 
        - gnome-text-editor 

  # 4. SERVICES: Enable essential daemons
  - type: services
    enable:
      - libvirtd.service 
      - pmlogger.service 
      - osbuild-composer.socket
      - cockpit.socket          # Cockpit service enabled

  # 5. FLATPAK REMOTE FIX ðŸš¨ NEW MODULE ADDED ðŸš¨
  - type: flatpak-remote
    install:
      # Ensures Flathub is defined before installing apps
      - remote: flathub
        url: https://flathub.org/repo/flathub.flatpakrepo
        system: true

  # 6. GNOME DESKTOP MINIMALISM & iGPU ENFORCEMENT
  - type: gnome
    integrated-gpu-priority: true
    remove: 
      - gnome-tour
      - gnome-shell-extension-background-logo
      - rhythmbox
      - baobab 

  # 7. DEFAULT FLATPAKS: Essential Host Management
  - type: default-flatpaks
    configurations:
      - notify: true
        scope: system
        install: 
          - app.zen_browser.zen 
          - org.gnome.Loupe
          - io.podman_desktop.PodmanDesktop 
          - org.virt_manager.VirtManager 
          - io.github.kolunmi.Bazaar   # Bazaar added
        remove:
          - org.mozilla.firefox        # Firefox Flatpak removal fix
      - scope: user 

  # 8. SIGNING (No change needed)
  - type: signing
