name: bluebuild
on:
  push:
    branches: [ main ]
  workflow_dispatch:

jobs:
  # Signed build using cosign keys (current behavior)
  bluebuild:
    runs-on: ubuntu-latest
    permissions:
      contents: read
      packages: write
      id-token: write
    strategy:
      matrix:
        recipe:
          - recipe.yml
    steps:
      - name: Checkout repository
        uses: actions/checkout@v4

      # Recreate cosign public key from secret at runtime
      - name: Provide cosign public key (from secret)
        env:
          COSIGN_PUB: ${{ secrets.COSIGN_PUB }}
        run: |
          if [ -n "$COSIGN_PUB" ]; then
            printf '%s\n' "$COSIGN_PUB" > cosign.pub
            chmod 644 cosign.pub
          else
            echo "COSIGN_PUB not set; skipping cosign.pub creation"
          fi

      # Recreate cosign private key from secret at runtime
      - name: Provide cosign private key (from secret)
        env:
          COSIGN_PRIVATE_KEY: ${{ secrets.COSIGN_PRIVATE_KEY }}
        run: |
          if [ -n "$COSIGN_PRIVATE_KEY" ]; then
            printf '%s\n' "$COSIGN_PRIVATE_KEY" > cosign.key
            chmod 600 cosign.key
          else
            echo "COSIGN_PRIVATE_KEY not set; skipping cosign.key creation"
          fi

      # Debug: show what cosign.pub looks like in CI (to compare with local file)
      - name: Debug cosign.pub contents
        run: |
          echo "=== cosign.pub (visible) ==="
          sed -n '1,5p' cosign.pub || echo "cosign.pub missing"
          echo
          echo "=== cosign.pub (hex) ==="
          if [ -f cosign.pub ]; then
            xxd -p cosign.pub
          else
            echo "no cosign.pub"
          fi

      - name: Build Custom Image (blue-build)
        uses: blue-build/github-action@v1.10
        env:
          COSIGN_PRIVATE_KEY: ${{ secrets.COSIGN_PRIVATE_KEY }}
        with:
          recipe: ${{ matrix.recipe }}
          registry_token: ${{ github.token }}
          pr_event_number: ${{ github.event.number }}
          use_unstable_cli: true
          maximize_build_space: true
          # Let BlueBuild auto-detect the cosign key pair
          build_opts: ""

  # Unsigned build to verify that everything else works without cosign
  bluebuild-no-sign:
    runs-on: ubuntu-latest
    permissions:
      contents: read
      packages: write
      id-token: write
    strategy:
      matrix:
        recipe:
          - recipe.yml
    steps:
      - name: Checkout repository
        uses: actions/checkout@v4

      # No cosign key steps here on purpose â€“ this job runs without signing
      - name: Build Custom Image without signing (blue-build)
        uses: blue-build/github-action@v1.10
        with:
          recipe: ${{ matrix.recipe }}
          registry_token: ${{ github.token }}
          pr_event_number: ${{ github.event.number }}
          use_unstable_cli: true
          maximize_build_space: true
          # Explicitly disable signing so cosign is not invoked
          build_opts: --no-sign
